name: Allure Report CI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write    # ğŸ‘ˆ necesario para publicar en gh-pages
  pages: write

jobs:
  test:
    name: Run Tests and Publish Allure Report
    runs-on: ubuntu-latest

    env:
      WOMPI_SANBOX_URL: "https://api-sandbox.co.uat.wompi.dev/v1"
      WOMPI_PROD_URL: "https://api.co.uat.wompi.dev/v1"
      WOMPI_PUBLIC_KEY: "pub_stagtest_5i0ZGIGiFcDQifYsXxvsny7Y37tKqFWg"
      WOMPI_PRIVATE_KEY: "prv_stagtest_5i0ZGIGiFcDQifYsXxvsny7Y37tKqFWg"

    steps:
      - name: ğŸ§± Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # âœ… Verificar que las variables de entorno existen
      - name: ğŸ” Validate environment variables
        run: |
          echo "Verificando variables de entorno..."
          REQUIRED_VARS=("WOMPI_SANBOX_URL" "WOMPI_PROD_URL" "WOMPI_PUBLIC_KEY" "WOMPI_PRIVATE_KEY")
          for var in "${REQUIRED_VARS[@]}"; do
            if [ -z "${!var}" ]; then
              echo "âŒ ERROR: $var no estÃ¡ definida o estÃ¡ vacÃ­a."
              exit 1
            else
              echo "âœ… $var detectada (${#var} chars)"
            fi
          done

      - name: ğŸ§ª Run tests
        run: mvn clean test

      # ğŸ“Š Generar reporte Allure
      - name: ğŸ“Š Generate Allure report
        run: |
          npm install -g allure-commandline
          allure generate target/allure-results --clean -o target/allure-report
          echo "âœ… Reporte Allure generado en target/allure-report"

      # ğŸ“¦ Subir reporte como artefacto descargable
      - name: ğŸ“¦ Upload Allure report artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: target/allure-report

      # ğŸŒ Publicar reporte en GitHub Pages
      - name: ğŸš€ Deploy Allure report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./target/allure-report
          force_orphan: true
